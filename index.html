<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spider Swing</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
  html, body { margin:0; padding:0; overflow:hidden; touch-action:none; }
  canvas { display:block; }
  #score {
    position:absolute; top:20px; left:20px;
    color:#fff; font-size:24px; font-weight:bold;
    text-shadow:2px 2px 6px #000;
  }
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="score">Score: 0</div>
<audio id="whoosh" src="https://freesound.org/data/previews/256/256113_3263906-lq.mp3"></audio>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let W=innerWidth, H=innerHeight;
canvas.width=W; canvas.height=H;

// Assets
const whoosh = document.getElementById('whoosh');

// Game variables
let score=0;
const ropeLen=300;
let angle=Math.PI/3, av=0, aa=0;
const gravity=0.4, damping=0.993, swingBoost=0.0012, latchBoost=0.04;
let spider={x:0,y:0,vx:0,vy:0};
let anchors=[];
let idx=0, swinging=true, holding=false, cam=0;

// Effects
let particles=[];
class Particle {
  constructor(x,y){
    this.x=x; this.y=y;
    this.vx=(Math.random()-0.5)*4;
    this.vy=(Math.random()-1.5)*4;
    this.alpha=1; this.size=2+Math.random()*3;
  }
  update(){ this.x+=this.vx; this.y+=this.vy; this.alpha -= 0.02; }
  draw(){
    ctx.fillStyle=`rgba(255,255,255,${this.alpha})`;
    ctx.beginPath(); ctx.arc(this.x, this.y, this.size,0,2*Math.PI);
    ctx.fill();
  }
}

// Night sky + skyline + stars
const skyline=[];
for(let i=0;i<20;i++){
  const w=100+Math.random()*100, h=200+Math.random()*200;
  skyline.push({x:i*w*1.5, y:H-h-50, w,h});
}
const stars=Array.from({length:100},()=>({x:Math.random()*W, y:Math.random()*H*0.6}));

function generateAnchors(){
  anchors=[]; let x=150;
  for(let i=0;i<60;i++){
    const height=200+Math.random()*250;
    anchors.push({x, y:H-height, w:60});
    x += 250+Math.random()*200;
  }
}
generateAnchors();

function getA(){return anchors[idx];}
function updatePos(){const a=getA();
  spider.x = a.x + ropeLen*Math.sin(angle);
  spider.y = a.y + ropeLen*Math.cos(angle);
}
function reset(){
  idx=0; angle=Math.PI/3; av=0; swinging=true; holding=false;
  updatePos(); spider.vx=0; spider.vy=0; cam=0; score=0;
}
function nearestAnchor(){
  let best=null, d=1e9;
  anchors.forEach((a,i)=>{
    if(i<=idx) return;
    const dx=spider.x-a.x, dy=spider.y-a.y;
    const dd=Math.hypot(dx,dy);
    if(dd<d){d=dd; best={a,i,dd};}
  });
  return best;
}
function playWhoosh(){whoosh.currentTime=0; whoosh.play();}

function update(){
  const a=getA();
  if(swinging){
    aa = (-gravity/ropeLen)*Math.sin(angle);
    if(holding) aa += swingBoost*(av>0?1:-1);
    av += aa; av *= damping; angle += av;
    updatePos();
    score = Math.max(score, Math.floor(spider.x - cam));
    // mid-air latch if holding
    const near = nearestAnchor();
    if(holding && near && near.dd<180){
      idx=near.i; swinging=true;
      angle = Math.atan2(spider.x - near.a.x, spider.y - near.a.y);
      av = Math.sign(av)*latchBoost;
      playWhoosh();
      // particles
      for(let i=0;i<20;i++) particles.push(new Particle(spider.x-cam, spider.y));
    }
  } else {
    spider.vy+=gravity; spider.x+=spider.vx; spider.y+=spider.vy;
    cam += (spider.x - cam - 150)*0.06;
    // auto-latch
    const near2 = nearestAnchor();
    if(near2 && near2.dd<60){
      idx=near2.i; swinging=true;
      angle = Math.atan2(spider.x - near2.a.x, spider.y - near2.a.y);
      av = spider.vx/20;
      spider.vx=spider.vy=0;
      playWhoosh();
      for(let i=0;i<20;i++) particles.push(new Particle(spider.x-cam, spider.y));
    }
    if(spider.y>H+200 || spider.x<cam-200) reset();
  }
  particles = particles.filter(p=>p.alpha>0);
  particles.forEach(p=>p.update());
}

function draw(){
  ctx.clearRect(0,0,W,H);
  // Night sky
  ctx.fillStyle='#001830'; ctx.fillRect(0,0,W,H);
  // stars
  ctx.fillStyle='#fff';
  stars.forEach(s=>ctx.fillRect(s.x-cam*0.02, s.y,2,2));
  // skyline
  ctx.fillStyle='#111';
  skyline.forEach(b=>ctx.fillRect(b.x-cam*0.3, b.y, b.w, b.h));
  // clouds?
  // anchors
  ctx.fillStyle='#222';
  anchors.forEach(a=>ctx.fillRect(a.x-25-cam, a.y, a.w, H-a.y));
  // rope
  if(swinging){
    const a0=getA();
    ctx.lineWidth=2; ctx.strokeStyle='#fff';
    ctx.beginPath();
    ctx.moveTo(a0.x-cam, a0.y);
    ctx.lineTo(spider.x-cam, spider.y);
    ctx.stroke();
  }
  // particles
  particles.forEach(p=>p.draw());
  // spider
  const sx=spider.x-cam, sy=spider.y;
  ctx.lineWidth=4; ctx.strokeStyle='#000'; ctx.fillStyle='#e30c0c';
  ctx.beginPath(); ctx.arc(sx, sy-20,12,0,2*Math.PI);
  ctx.fill(); ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(sx,sy-10); ctx.lineTo(sx,sy+20);
  ctx.moveTo(sx,sy); ctx.lineTo(sx-15,sy+10);
  ctx.moveTo(sx,sy); ctx.lineTo(sx+15,sy+10);
  ctx.moveTo(sx,sy+20); ctx.lineTo(sx-10,sy+40);
  ctx.moveTo(sx,sy+20); ctx.lineTo(sx+10,sy+40);
  ctx.stroke();
  document.getElementById('score').innerText = 'Score: '+score;
}

canvas.addEventListener('touchstart', ()=>{
  if(swinging) holding=true;
  else{
    const near=nearestAnchor();
    if(near&&near.dd<200){
      idx=near.i; swinging=true;
      angle = Math.atan2(spider.x-near.a.x, spider.y-near.a.y);
      av = latchBoost;
      playWhoosh();
      for(let i=0;i<20;i++) particles.push(new Particle(spider.x-cam, spider.y));
    }
  }
});
canvas.addEventListener('touchend', ()=>{
  if(swinging){ holding=false; swinging=false;
    spider.vx = av*ropeLen*Math.cos(angle+Math.PI/2);
    spider.vy = av*ropeLen*Math.sin(angle+Math.PI/2);
  }
});

canvas.addEventListener('mousedown', ()=>{ if(swinging) holding=true; else{
  const near=nearestAnchor();
    if(near&&near.dd<200){
      idx=near.i; swinging=true;
      angle = Math.atan2(spider.x-near.a.x, spider.y-near.a.y);
      av = latchBoost;
      playWhoosh();
      for(let i=0;i<20;i++) particles.push(new Particle(spider.x-cam, spider.y));
    } }});
canvas.addEventListener('mouseup', ()=>{ if(swinging){
    holding=false; swinging=false;
    spider.vx = av*ropeLen*Math.cos(angle+Math.PI/2);
    spider.vy = av*ropeLen*Math.sin(angle+Math.PI/2);
}});

reset(); loop();

function reset(){ reset() }
function loop(){ update(); draw(); requestAnimationFrame(loop); }
</script>
</body>
</html>
